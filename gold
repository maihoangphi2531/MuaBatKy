-- Danh sách người bán
local shopData = {
    {seller = "pandabois54"},
    {seller = "StevensElijah33"},
    {seller = "lalaa13123"},
    {seller = "lalaa1756"},
}

-- Tên món đồ cần mua
local itemName = "DeconstructionStone"

-- Hàm thực hiện mua các món với ưu tiên giá
local function buyItemsWithPriority(shopOwnerName)
    -- Tìm folder shop của chủ shop trong ReplicatedStorage
    local playerShops = game:GetService("ReplicatedStorage"):WaitForChild("PlayerShops")
    local shopFolder = playerShops:FindFirstChild(shopOwnerName)
    if not shopFolder then
        warn("Không tìm thấy shop của:", shopOwnerName)
        return false
    end

    -- Truy cập folder SellShop và Items
    local sellShopFolder = shopFolder:FindFirstChild("SellShop")
    if not sellShopFolder then
        warn("Không tìm thấy SellShop trong shop của:", shopOwnerName)
        return false
    end

    local itemsFolder = sellShopFolder:FindFirstChild("Items")
    if not itemsFolder then
        warn("Không tìm thấy folder Items trong SellShop của:", shopOwnerName)
        return false
    end

    -- Danh sách các stone để mua
    local priorityStones = {}
    local otherStones = {}

    -- Phân loại các stone dựa trên giá
    for _, stone in pairs(itemsFolder:GetChildren()) do
        if stone.Name == itemName then
            local askingPrice = stone:FindFirstChild("AskingPrice")
            if askingPrice and askingPrice:IsA("IntValue") then
                if askingPrice.Value == 99999999 then
                    table.insert(priorityStones, stone)
                else
                    table.insert(otherStones, stone)
                end
            end
        end
    end

    local function buyStone(stone)
        local shopOwner = game:GetService("Players"):FindFirstChild(shopOwnerName)
        if not shopOwner then
            warn("Không tìm thấy player có tên:", shopOwnerName)
            return false
        end

        local success, errorMessage = pcall(function()
            game:GetService("ReplicatedStorage")
                :WaitForChild("Shared")
                :WaitForChild("Shop")
                :WaitForChild("Buy")
                :InvokeServer(shopOwner, stone)
        end)

        if success then
            print("Mua thành công DeconstructionStone từ shop của:", shopOwnerName, "với giá:", stone:FindFirstChild("AskingPrice").Value)
            return true
        else
            warn("Gặp lỗi khi mua từ shop của:", shopOwnerName, "- Lỗi:", errorMessage)
            return false
        end
    end

    -- Mua các stone ưu tiên trước
    local stonesBought = 0
    for _, stone in ipairs(priorityStones) do
        if buyStone(stone) then
            stonesBought = stonesBought + 1
        end
    end

    -- Mua các stone khác sau
    for _, stone in ipairs(otherStones) do
        if buyStone(stone) then
            stonesBought = stonesBought + 1
        end
    end

    if stonesBought == 0 then
        warn("Không tìm thấy DeconstructionStone nào trong shop của:", shopOwnerName)
        return false
    else
        print("Đã mua thành công", stonesBought, "DeconstructionStone từ shop của:", shopOwnerName)
        return true
    end
end

-- Thực hiện kiểm tra và mua theo danh sách
for _, shop in ipairs(shopData) do
    print("Đang kiểm tra shop của:", shop.seller)
    local success = buyItemsWithPriority(shop.seller)
    if success then
        print("Hoàn tất mua từ shop:", shop.seller)
    else
        print("Không thể mua từ shop:", shop.seller)
    end
end
